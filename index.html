<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotizador NEMOC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f7fbff; }
    h2 { color:#003366; margin-bottom:6px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { font-weight:600; font-size: 14px; }
    input, textarea { width: 100%; padding: 8px; border:1px solid #cfd6e4; border-radius: 6px; }
    textarea { min-height: 80px; }
    table { width:100%; border-collapse:collapse; margin-top:14px; background:#fff; }
    th, td { border:1px solid #dde3f0; padding:8px; text-align:center; }
    th { background:#003366; color:#fff; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    button { background:#003366; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#64748b; }
    button.danger { background:#b91c1c; }
    button:hover { filter: brightness(1.05); }
    .totals { margin-top: 8px; font-weight:600; }
  </style>
</head>
<body>
  <h2>üìÑ Generador de Cotizaciones - NEMOC Multiservicios Ingenier√≠a y Tecnolog√≠a</h2>

  <div class="grid">
    <div>
      <label>Cliente</label>
      <input id="cliente" placeholder="Nombre / Raz√≥n Social"/>
    </div>
    <div>
      <label>Empresa</label>
      <input id="empresa" placeholder="(Opcional)"/>
    </div>
    <div>
      <label>NIT</label>
      <input id="nit" placeholder="NIT o c√©dula"/>
    </div>
    <div>
      <label>Tel√©fono</label>
      <input id="telefono" placeholder="318..."/>
    </div>
    <div>
      <label>Correo</label>
      <input id="correo" type="email" placeholder="correo@empresa.com"/>
    </div>
    <div>
      <label>Direcci√≥n</label>
      <input id="direccion" placeholder="Calle..."/>
    </div>
  </div>

  <div style="margin-top:16px;">
    <label>% IVA</label>
    <input id="iva" type="number" value="19" step="0.01"/>
  </div>

  <div style="margin-top:12px;">
    <label>Condiciones comerciales</label>
    <textarea id="condiciones">Tiempo de entrega: inmediato.
Forma de pago: transferencia bancaria.
Validez: 15 d√≠as.</textarea>
  </div>

  <table id="items">
    <thead>
      <tr>
        <th>Cantidad</th>
        <th>Descripci√≥n</th>
        <th>Valor Unitario</th>
        <th>Total</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="actions">
    <button type="button" id="btnAdd">‚ûï Agregar √çtem</button>
    <button type="button" id="btnPDF">üìë Generar PDF</button>
    <button type="button" id="btnClear" class="danger">üóëÔ∏è Limpiar √çtems</button>
  </div>
  <div class="totals" id="totalsView"></div>

  <script src="logo_nemoc_base64.js"></script>
  <script>
    const { jsPDF } = window.jspdf;
    const $ = s => document.querySelector(s);
    const tbody = $("#items tbody");
    const fmt = n => new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 2 }).format(n || 0);

    function rowTemplate() {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="number" min="0" step="1" value="1"/></td>
        <td><input type="text" placeholder="Descripci√≥n del √≠tem"/></td>
        <td><input type="number" min="0" step="0.01" value="0"/></td>
        <td class="totalCell">0</td>
        <td><button type="button" class="secondary btnDel">Eliminar</button></td>
      `;
      return tr;
    }

    function recalcRow(tr) {
      const qty = parseFloat(tr.children[0].querySelector('input').value) || 0;
      const unit = parseFloat(tr.children[2].querySelector('input').value) || 0;
      const tot = qty * unit;
      tr.querySelector('.totalCell').textContent = fmt(tot);
      return tot;
    }

    function recalcAll() {
      let subtotal = 0;
      tbody.querySelectorAll('tr').forEach(tr => subtotal += recalcRow(tr));
      const iva = parseFloat($("#iva").value) || 0;
      const ivaVal = subtotal * (iva/100);
      const total = subtotal + ivaVal;
      $("#totalsView").textContent = `Subtotal: ${fmt(subtotal)}  |  IVA (${iva}%): ${fmt(ivaVal)}  |  TOTAL: ${fmt(total)}`;
      return { subtotal, iva, ivaVal, total };
    }

    function addRow() {
      const tr = rowTemplate();
      tbody.appendChild(tr);
      recalcRow(tr);
    }

    function clearRows() {
      tbody.innerHTML = "";
      addRow();
      recalcAll();
    }

    // Event delegation for inputs and buttons
    tbody.addEventListener('input', (e) => {
      if (e.target.tagName === 'INPUT') {
        recalcAll();
      }
    });

    tbody.addEventListener('click', (e) => {
      if (e.target.classList.contains('btnDel')) {
        e.target.closest('tr').remove();
        if (!tbody.querySelector('tr')) addRow();
        recalcAll();
      }
    });

    $("#btnAdd").addEventListener('click', addRow);
    $("#iva").addEventListener('input', recalcAll);
    $("#btnClear").addEventListener('click', clearRows);

    // PDF
    $("#btnPDF").addEventListener('click', () => {
      const doc = new jsPDF();

      // Header with logo
      try {
        if (typeof LOGO_BASE64 === 'string' && LOGO_BASE64.startsWith('data:image')) {
          doc.addImage(LOGO_BASE64, 'PNG', 12, 8, 38, 18);
        }
      } catch (e) {}

      doc.setFontSize(14);
      doc.text('COTIZACI√ìN', 105, 15, { align: 'center' });
      doc.setFontSize(10);
      doc.text('NEMOC Multiservicios Ingenier√≠a y Tecnolog√≠a', 105, 21, { align: 'center' });
      doc.text('Tel: 3185621097  |  Email: nemoca1004@gmail.com', 105, 26, { align: 'center' });
      doc.text('Calle 45 # 35-36, Barrio L√≠bano, Santa Marta', 105, 31, { align: 'center' });

      const fecha = new Date().toLocaleDateString('es-CO');
      doc.text(`Fecha: ${fecha}`, 180, 38, { align: 'right' });

      // Cliente table
      const clienteRows = [
        ['Cliente', $('#cliente').value || ''],
        ['Empresa', $('#empresa').value || ''],
        ['NIT', $('#nit').value || ''],
        ['Tel√©fono', $('#telefono').value || ''],
        ['Correo', $('#correo').value || ''],
        ['Direcci√≥n', $('#direccion').value || ''],
      ];
      doc.autoTable({ startY: 44, head: [['Campo', 'Detalle']], body: clienteRows, theme: 'grid', styles:{ fontSize:9 } });

      // Items
      const itemRows = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const qty = tr.children[0].querySelector('input').value || '0';
        const desc = tr.children[1].querySelector('input').value || '';
        const unit = parseFloat(tr.children[2].querySelector('input').value) || 0;
        const tot = (parseFloat(qty)||0) * unit;
        itemRows.push([qty, desc, fmt(unit), fmt(tot)]);
      });
      doc.autoTable({ startY: doc.lastAutoTable.finalY + 8, head: [['Cant.', 'Descripci√≥n', 'V. Unitario', 'Total']], body: itemRows, styles:{ fontSize:9 } });

      const sums = recalcAll();
      // Totals table
      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 6,
        body: [
          ['Subtotal', fmt(sums.subtotal)],
          [`IVA (${sums.iva}%)`, fmt(sums.ivaVal)],
          ['TOTAL', fmt(sums.total)]
        ],
        theme: 'plain',
        styles: { halign: 'right', fontSize: 10 },
        columnStyles: { 0: { halign: 'right' }, 1: { halign: 'right' } }
      });

      // Condiciones
      const y = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(11);
      doc.text('Condiciones comerciales:', 14, y);
      doc.setFontSize(9);
      doc.text(doc.splitTextToSize($('#condiciones').value || '', 180), 14, y + 6);

      doc.save('cotizacion_nemoc.pdf');
    });

    // init
    addRow();
    recalcAll();
  </script>
</body>
</html>
